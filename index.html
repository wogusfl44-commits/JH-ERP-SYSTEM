<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud ERP System V3.2 (Firebase Online)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css">

    <!-- Firebase Compat -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        :root {
            --font-main: 'Pretendard', sans-serif;
            --bg-sidebar: #111827;
        }

        body {
            font-family: var(--font-main);
            background-color: #f3f4f6;
            color: #374151;
        }

        .card-panel {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(229, 231, 235, 0.5);
            transition: transform 0.2s;
        }

        .card-panel:hover {
            transform: translateY(-2px);
        }

        .sidebar {
            width: 260px;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            background: var(--bg-sidebar);
            color: white;
            z-index: 50;
            transition: 0.3s;
        }

        .main-content {
            margin-left: 260px;
            padding: 2rem;
            min-height: 100vh;
            transition: 0.3s;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
            }
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div id="loading-overlay" class="fixed inset-0 bg-white/90 z-[9999] flex flex-col justify-center items-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mb-4"></div>
        <p class="text-gray-600 font-bold animate-pulse">Connecting to Cloud...</p>
    </div>

    <div id="app"></div>

    <script>
        // ==========================================
        // 1. Firebase Configuration
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCnztzEkrThAGqZTBjxWZ7NXVTS3ipBhCA",
            authDomain: "jaehyun-2310.firebaseapp.com",
            projectId: "jaehyun-2310",
            storageBucket: "jaehyun-2310.firebasestorage.app",
            messagingSenderId: "376312208756",
            appId: "1:376312208756:web:38f9aea87d787c7f56a021",
            measurementId: "G-KBZ9CQN5MZ"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ==========================================
        // 2. State & Components
        // ==========================================
        let currentUser = null;
        let currentTab = 'dashboard';

        function renderSidebar(active) {
            const menus = [
                { id: 'dashboard', icon: 'fa-chart-pie', label: 'ëŒ€ì‹œë³´ë“œ' },
                { id: 'materials', icon: 'fa-box-open', label: 'ìì¬ ê´€ë¦¬' },
                { id: 'equipment', icon: 'fa-tools', label: 'ì„¤ë¹„ ê´€ë¦¬' },
                { id: 'inout', icon: 'fa-exchange-alt', label: 'ì…ì¶œê³  ì²˜ë¦¬' },
                { id: 'suppliers', icon: 'fa-handshake', label: 'ê±°ë˜ì²˜ ê´€ë¦¬' },
                { id: 'guide', icon: 'fa-book-reader', label: 'ì‚¬ìš© ê°€ì´ë“œ' }
            ];
            return `
                <aside class="sidebar flex flex-col">
                    <div class="p-6 border-b border-gray-800">
                        <h1 class="text-lg font-bold text-white"><i class="fas fa-cloud mr-2 text-blue-500"></i>Smart ERP</h1>
                        <p class="text-[10px] text-gray-500 mt-1">Online Mode</p>
                        <div class="mt-6 flex items-center p-3 bg-gray-800 rounded-lg">
                            <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-xs font-bold mr-3 text-white">U</div>
                            <div><p class="text-sm font-medium text-white">${currentUser?.name}</p><div class="text-[10px] text-green-400">Online</div></div>
                        </div>
                    </div>
                    <nav class="flex-1 py-4 space-y-1">
                        ${menus.map(m => `<div onclick="switchTab('${m.id}')" class="px-6 py-3 cursor-pointer flex items-center text-gray-400 hover:text-white hover:bg-white/5 ${active === m.id ? 'border-l-4 border-blue-500 bg-gradient-to-r from-blue-900/20 to-transparent text-white' : ''}"><i class="fas ${m.icon} w-6"></i> ${m.label}</div>`).join('')}
                    </nav>
                    <div class="p-4 border-t border-gray-800"><button onclick="auth.signOut()" class="w-full text-gray-400 hover:text-white py-2 text-sm"><i class="fas fa-sign-out-alt mr-2"></i>ë¡œê·¸ì•„ì›ƒ</button></div>
                </aside>`;
        }

        function renderHeader(title) {
            return `
                <header class="bg-gradient-to-r from-blue-700 to-blue-600 text-white p-8 rounded-2xl mb-8 shadow-lg flex justify-between items-end">
                    <div><p class="text-blue-200 text-sm font-medium mb-1">${new Date().toLocaleDateString()}</p><h2 class="text-3xl font-bold">${title}</h2></div>
                    <div class="hidden md:block"><span class="bg-white/10 px-4 py-2 rounded-lg text-sm backdrop-blur-sm">Cloud ERP System</span></div>
                </header>`;
        }

        // ==========================================
        // 3. Pages
        // ==========================================
        async function renderDashboard(c) {
            c.innerHTML = `<div class="grid grid-cols-4 gap-6 animate-pulse">${'<div class="h-32 bg-gray-200 rounded-xl"></div>'.repeat(4)}</div>`;
            try {
                const [mSnap, sSnap] = await Promise.all([db.collection('materials').get(), db.collection('suppliers').get()]);
                const mats = mSnap.docs.map(d => d.data());
                const low = mats.filter(m => m.currentStock <= m.safetyStock);

                c.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 animate-fade-in-up">
                        <div class="card-panel p-6 border-l-4 border-blue-500 cursor-pointer" onclick="switchTab('materials')"><p class="text-xs font-bold text-gray-400">ì´ ìì¬</p><h3 class="text-3xl font-bold mt-2">${mats.filter(m => m.type === 'material').length}</h3></div>
                        <div class="card-panel p-6 border-l-4 border-emerald-500 cursor-pointer" onclick="switchTab('equipment')"><p class="text-xs font-bold text-gray-400">ì´ ì„¤ë¹„</p><h3 class="text-3xl font-bold mt-2">${mats.filter(m => m.type === 'equipment').length}</h3></div>
                        <div class="card-panel p-6 border-l-4 border-violet-500"><p class="text-xs font-bold text-gray-400">ì´ ìì‚°</p><h3 class="text-2xl font-bold mt-2">â‚© ${mats.reduce((a, b) => a + (b.price * b.currentStock), 0).toLocaleString()}</h3></div>
                        <div class="card-panel p-6 border-l-4 border-red-500 cursor-pointer" onclick="document.getElementById('low-stock').scrollIntoView()"><p class="text-xs font-bold text-red-400">ë¶€ì¡± ì•Œë¦¼</p><h3 class="text-3xl font-bold text-red-600 ${low.length ? 'animate-pulse' : ''}">${low.length}</h3></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 animate-fade-in-up">
                        <div class="card-panel p-6"><h3 class="font-bold text-lg mb-6">ì¹´í…Œê³ ë¦¬ í˜„í™©</h3><div class="h-80"><canvas id="chart"></canvas></div></div>
                        <div class="card-panel p-6" id="low-stock"><h3 class="font-bold text-lg mb-6 text-red-600">ğŸš¨ ì¬ê³  ë¶€ì¡± ëª©ë¡</h3>
                            <div class="overflow-y-auto h-80 border rounded-lg"><table class="w-full text-sm text-left"><thead class="bg-red-50 text-red-700 sticky top-0"><tr><th class="p-4">í’ˆëª©</th><th class="p-4 text-center">í˜„ì¬ê³ </th><th class="p-4 text-right">ë¶€ì¡±ë¶„</th></tr></thead><tbody>${low.map(m => `<tr class="border-b"><td class="p-4">${m.name}</td><td class="p-4 text-center font-bold text-red-600">${m.currentStock}</td><td class="p-4 text-right">-${m.safetyStock - m.currentStock}</td></tr>`).join('')}</tbody></table></div>
                        </div>
                    </div>`;

                setTimeout(() => {
                    const ctx = document.getElementById('chart');
                    if (ctx) {
                        const cats = {}; mats.forEach(m => { const c = m.category || 'ê¸°íƒ€'; cats[c] = (cats[c] || 0) + 1; });
                        new Chart(ctx, { type: 'bar', data: { labels: Object.keys(cats), datasets: [{ label: 'í’ˆëª© ìˆ˜', data: Object.values(cats), backgroundColor: '#3b82f6' }] }, options: { maintainAspectRatio: false } });
                    }
                }, 0);
            } catch (e) { c.innerHTML = `<div class="text-red-500 p-4">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${e.message}</div>`; }
        }

        async function renderList(c, type) {
            const isMaster = currentUser.role === 'master';
            c.innerHTML = `
                <div class="card-panel p-6 animate-fade-in-up">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-xl border-l-4 border-blue-600 pl-3">${type === 'material' ? 'ìì¬' : 'ì„¤ë¹„'} ëª©ë¡</h3>
                        <div class="flex gap-2 ${isMaster ? '' : 'hidden'}">
                            <button onclick="document.getElementById('excel').click()" class="btn bg-green-500 text-white px-4 py-2 rounded-lg text-sm"><i class="fas fa-file-excel mr-2"></i>ì—‘ì…€ ë“±ë¡</button>
                            <input type="file" id="excel" class="hidden" accept=".csv" onchange="handleExcel(this, '${type}')">
                            <button onclick="addItem('${type}')" class="btn bg-blue-600 text-white px-4 py-2 rounded-lg text-sm"><i class="fas fa-plus mr-2"></i>ë“±ë¡</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto rounded-lg border"><table class="w-full text-sm text-left"><thead class="bg-gray-50 font-bold text-gray-700"><tr><th class="p-4">ì½”ë“œ</th><th class="p-4">í’ˆëª©ëª…</th><th class="p-4">ê·œê²©</th><th class="p-4">ê³µê¸‰ì‚¬</th><th class="p-4 text-right">ë‹¨ê°€</th><th class="p-4 text-center">ì¬ê³ </th><th class="p-4 text-center">ê´€ë¦¬</th></tr></thead>
                    <tbody id="mat-body"><tr><td colspan="7" class="p-8 text-center">ë¡œë”©ì¤‘...</td></tr></tbody></table></div>
                </div>`;

            const snap = await db.collection('materials').where('type', '==', type).orderBy('timestamp', 'desc').get();
            document.getElementById('mat-body').innerHTML = snap.empty ? `<tr><td colspan="7" class="p-8 text-center text-gray-400">ë°ì´í„° ì—†ìŒ</td></tr>` :
                snap.docs.map(d => {
                    const i = { id: d.id, ...d.data() };
                    return `<tr class="hover:bg-gray-50"><td class="p-4 text-gray-500">${i.code}</td><td class="p-4 font-bold">${i.name}</td><td class="p-4 text-xs">${i.spec || '-'}</td><td class="p-4">${i.company || '-'}</td><td class="p-4 text-right">${i.price.toLocaleString()}</td><td class="p-4 text-center font-bold ${i.currentStock <= i.safetyStock ? 'text-red-600' : 'text-blue-600'}">${i.currentStock}</td><td class="p-4 text-center">${isMaster ? `<button onclick="delItem('materials','${i.id}')"><i class="fas fa-trash text-gray-400 hover:text-red-500"></i></button>` : '-'}</td></tr>`;
                }).join('');
        }

        async function renderSuppliers(c) {
            c.innerHTML = `
                <div class="card-panel p-6 animate-fade-in-up">
                    <div class="flex justify-between mb-4"><h3 class="font-bold text-xl border-l-4 border-purple-600 pl-3">ê±°ë˜ì²˜ ëª©ë¡</h3>${currentUser.role === 'master' ? `<button onclick="addSupplier()" class="btn bg-purple-600 text-white px-4 py-2 rounded-lg text-sm">ë“±ë¡</button>` : ''}</div>
                    <div class="overflow-x-auto rounded-lg border"><table class="w-full text-sm text-left"><thead class="bg-gray-50 font-bold"><tr><th class="p-4">ì—…ì²´ëª…</th><th class="p-4">ì—°ë½ì²˜</th><th class="p-4">ì¹´í…Œê³ ë¦¬</th><th class="p-4 text-center">ê´€ë¦¬</th></tr></thead>
                    <tbody id="sup-body"><tr><td colspan="4" class="p-8 text-center">ë¡œë”©ì¤‘...</td></tr></tbody></table></div>
                </div>`;
            const snap = await db.collection('suppliers').orderBy('timestamp', 'desc').get();
            document.getElementById('sup-body').innerHTML = snap.docs.map(d => {
                const s = { id: d.id, ...d.data() };
                return `<tr class="hover:bg-gray-50"><td class="p-4 font-bold">${s.name}</td><td class="p-4">${s.contact || '-'}</td><td class="p-4"><span class="bg-purple-100 text-purple-700 px-2 py-1 rounded text-xs">${s.category}</span></td><td class="p-4 text-center">${currentUser.role === 'master' ? `<button onclick="delItem('suppliers','${s.id}')"><i class="fas fa-trash text-gray-400 hover:text-red-500"></i></button>` : '-'}</td></tr>`;
            }).join('');
        }

        async function renderIO(c) {
            c.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fade-in-up">
                    <div class="card-panel p-6 h-fit"><h3 class="font-bold text-lg mb-4 border-b pb-2">ì…ì¶œê³  ë“±ë¡</h3>
                        <div class="space-y-4">
                            <select id="io-item" class="w-full border rounded-lg p-3 text-sm"><option>ë¡œë”©ì¤‘...</option></select>
                            <div class="grid grid-cols-2 gap-2"><button onclick="ioType='IN'; hlBtn(this)" class="btn border border-blue-200 text-blue-600 py-2 rounded-lg hover:bg-blue-50">ì…ê³ </button><button onclick="ioType='OUT'; hlBtn(this)" class="btn border border-red-200 text-red-600 py-2 rounded-lg hover:bg-red-50">ì¶œê³ </button></div>
                            <input type="number" id="io-qty" placeholder="ìˆ˜ëŸ‰" class="w-full border rounded-lg p-3 text-sm">
                            <button onclick="submitIO()" class="w-full bg-gray-800 text-white font-bold py-3 rounded-lg">ì²˜ë¦¬ ì™„ë£Œ</button>
                        </div>
                    </div>
                    <div class="card-panel p-6 lg:col-span-2"><h3 class="font-bold mb-4">ì²˜ë¦¬ ì´ë ¥</h3>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-gray-50 font-bold"><tr><th class="p-3">êµ¬ë¶„</th><th class="p-3">í’ˆëª©</th><th class="p-3">ìˆ˜ëŸ‰</th><th class="p-3">ë‹´ë‹¹</th><th class="p-3">ì‹œê°„</th></tr></thead>
                        <tbody id="tx-body"></tbody></table></div>
                    </div>
                </div>`;

            const snap = await db.collection('materials').get();
            document.getElementById('io-item').innerHTML = snap.docs.map(d => { const m = d.data(); return `<option value="${d.id}">[${m.code}] ${m.name} (${m.currentStock})</option>`; }).join('');

            const txSnap = await db.collection('transactions').orderBy('timestamp', 'desc').limit(20).get();
            document.getElementById('tx-body').innerHTML = txSnap.docs.map(d => {
                const t = d.data();
                return `<tr class="border-b"><td class="p-3 font-bold ${t.type === 'IN' ? 'text-blue-600' : 'text-red-600'}">${t.type === 'IN' ? 'ì…ê³ ' : 'ì¶œê³ '}</td><td class="p-3">${t.itemName}</td><td class="p-3">${t.qty}</td><td class="p-3">${t.user}</td><td class="p-3 text-xs text-gray-400">${t.date}</td></tr>`;
            }).join('');
        }

        function renderGuide(c) {
            c.innerHTML = `<div class="max-w-4xl mx-auto animate-fade-in-up"><div class="bg-gray-800 text-white p-8 rounded-2xl text-center mb-6"><h2 class="text-3xl font-bold">ì‚¬ìš© ê°€ì´ë“œ</h2><p>Online Mode (Firebase)</p></div><div class="card-panel p-6"><h3 class="font-bold text-lg mb-4">ğŸ“Œ ì—‘ì…€ ì¼ê´„ ë“±ë¡</h3><p>CSV íŒŒì¼ í˜•ì‹: <code>ì½”ë“œ, í’ˆëª©ëª…, ê·œê²©, ê³µê¸‰ì‚¬, ë‹¨ê°€, ì•ˆì „ì¬ê³ , í˜„ì¬ì¬ê³ , ì¹´í…Œê³ ë¦¬</code></p></div></div>`;
        }

        // ==========================================
        // 4. Logic
        // ==========================================
        let ioType = '';
        function hlBtn(el) { document.querySelectorAll('.btn').forEach(b => b.classList.remove('ring-2')); el.classList.add('ring-2'); }
        function switchTab(t) { currentTab = t; renderApp(); }

        function addItem(type) {
            const code = prompt("ì½”ë“œ:"), name = prompt("í’ˆëª©ëª…:");
            if (code && name) db.collection('materials').add({ type, code, name, currentStock: 0, safetyStock: 10, price: 0, category: 'ê¸°íƒ€', timestamp: firebase.firestore.FieldValue.serverTimestamp() }).then(() => renderApp());
        }
        function delItem(col, id) { if (confirm("ì‚­ì œ?")) db.collection(col).doc(id).delete().then(() => renderApp()); }

        async function submitIO() {
            const id = document.getElementById('io-item').value, qty = parseInt(document.getElementById('io-qty').value);
            if (!ioType || !qty) return alert("ì •ë³´ ë¶€ì¡±");
            const ref = db.collection('materials').doc(id);
            const doc = await ref.get();
            const item = doc.data();
            if (ioType === 'OUT' && item.currentStock < qty) return alert("ì¬ê³  ë¶€ì¡±");

            await ref.update({ currentStock: ioType === 'IN' ? item.currentStock + qty : item.currentStock - qty });
            await db.collection('transactions').add({ type: ioType, itemName: item.name, qty, user: currentUser.name, date: new Date().toLocaleString(), timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            alert("ì™„ë£Œ"); renderApp();
        }

        function handleExcel(input, type) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const rows = e.target.result.split('\n').slice(1);
                const batch = db.batch();
                rows.forEach(r => {
                    const c = r.split(',');
                    if (c.length >= 7) {
                        const ref = db.collection('materials').doc();
                        batch.set(ref, { type, code: c[0], name: c[1], spec: c[2], company: c[3], price: parseInt(c[4]) || 0, safetyStock: parseInt(c[5]) || 0, currentStock: parseInt(c[6]) || 0, category: c[7] || 'ê¸°íƒ€', timestamp: firebase.firestore.Timestamp.now() });
                    }
                });
                await batch.commit(); alert("ì™„ë£Œ"); renderApp();
            };
            reader.readAsText(file, 'EUC-KR');
        }

        // ==========================================
        // 5. Auth & Init
        // ==========================================
        function renderLogin() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-gray-900 p-4">
                    <div class="bg-white p-10 rounded-2xl shadow-2xl w-full max-w-md text-center">
                        <h1 class="text-2xl font-bold text-gray-900 mb-6">Cloud ERP V3.2</h1>
                        <form id="loginForm" onsubmit="event.preventDefault(); doLogin();" class="space-y-4">
                            <input type="email" id="email" placeholder="ì´ë©”ì¼" class="w-full p-3 border rounded-lg" required>
                            <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ìë¦¬ ì´ìƒ)" class="w-full p-3 border rounded-lg" required>
                            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700">ë¡œê·¸ì¸</button>
                            <button type="button" onclick="doSignup()" class="w-full bg-gray-100 text-gray-700 font-bold py-3 rounded-lg hover:bg-gray-200">íšŒì›ê°€ì…</button>
                        </form>
                    </div>
                </div>`;
        }

        function doLogin() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            auth.signInWithEmailAndPassword(e, p).catch(err => alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + err.message));
        }

        function doSignup() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            if (p.length < 6) return alert("ë¹„ë°€ë²ˆí˜¸ëŠ” 6ìë¦¬ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
            auth.createUserWithEmailAndPassword(e, p)
                .then(() => alert("ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤."))
                .catch(err => alert("ê°€ì… ì‹¤íŒ¨: " + err.message));
        }

        function renderApp() {
            const titles = { 'dashboard': 'ê²½ì˜ ëŒ€ì‹œë³´ë“œ', 'materials': 'ìì¬ ê´€ë¦¬', 'equipment': 'ì„¤ë¹„ ê´€ë¦¬', 'inout': 'ì…ì¶œê³  ì²˜ë¦¬', 'suppliers': 'ê±°ë˜ì²˜ ê´€ë¦¬', 'guide': 'ì‚¬ìš© ê°€ì´ë“œ' };
            document.getElementById('app').innerHTML = `
                <div class="flex min-h-screen bg-gray-50">
                    ${renderSidebar(currentTab)}
                    <main class="main-content flex-1">
                        ${renderHeader(titles[currentTab])}
                        <div id="content-area"></div>
                    </main>
                </div>`;
            const c = document.getElementById('content-area');
            if (currentTab === 'dashboard') renderDashboard(c);
            else if (currentTab === 'materials') renderList(c, 'material');
            else if (currentTab === 'equipment') renderList(c, 'equipment');
            else if (currentTab === 'suppliers') renderSuppliers(c);
            else if (currentTab === 'inout') renderIO(c);
            else if (currentTab === 'guide') renderGuide(c);
        }

        auth.onAuthStateChanged(user => {
            document.getElementById('loading-overlay').style.display = 'none';
            if (user) {
                const role = user.email.includes('admin') ? 'master' : 'staff';
                currentUser = { email: user.email, uid: user.uid, role, name: role === 'master' ? 'ê´€ë¦¬ì' : 'ì§ì›' };
                renderApp();
            } else {
                currentUser = null;
                renderLogin();
            }
        });
    </script>
</body>

</html>